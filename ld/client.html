<!DOCTYPE html>
<html>

<head>
    <style>
        * {
            font-family: Arial;
        }

        section {
            display: none;
        }

        .edit-link {
            visibility: hidden;
        }

        .edit-link::before {
            content: "âœŽ";
            visibility: visible;
        }

        body {
            margin: 0;
        }

        section {
            margin: 0;
            padding: 40px;
        }

        section {
            margin: 10px 0;
        }

        section>header {
            margin: -40px -40px 20px -40px;
        }

        header {

            padding: 10px;
            border-bottom: solid 1px black;
        }

        h1,
        h2,
        h3,
        h4 {
            margin: 0 0 10px 0;

        }

        body,
        input,
        select,
        textarea {
            font-size: 1em;
        }

        p {
            margin: 0 0 1em 0;
        }

        form {
            padding: 1em;
        }

        #browse-mode,
        #view-mode,
        #edit-mode {
            display: none;
        }

        .browse-mode #browse-mode {
            display: block;
        }

        .edit-mode #edit-mode {
            display: block;
        }

        .view-mode #view-mode {
            display: block;
        }

        input:invalid {
            color: red;
        }
    </style>
    <script src="./manage-sw.js"></script>
    <script src="./jsonld.min.js"></script>
    <script src="./ld-query.js"></script>
    <script type="module">
        import { fetchAndExpandObjects, fetchObjects } from "./fetcher.js";
        import { indexShapesByTargetClass } from "./shaper.js";
        import { renderPropEditor, renderPropViewer } from "./renderers.js";

        (async function () {

            const maybeAtob = x => x && atob(x);
            const emplaceText = (className, content) => Array
                .from(document.querySelectorAll(className))
                .forEach(el => el.textContent = content);

            const [contextDocument] = await fetchObjects("context");
            const context = contextDocument["@context"];

            const [teams, schema] = await fetchAndExpandObjects("teams", "schema");
            const schemaQuery = LD(schema, context);
            const teamsQuery = LD(teams, context);
            const shapeIndex = indexShapesByTargetClass(schemaQuery, context);
            const picker = document.querySelector("#picker");

window.st = {
    schemaQuery,
    teamsQuery
}
            const url = new URL(location.href);
            const currentMode = url.searchParams.get("mode") || "browse";
            document.querySelector("#mode-name").textContent = currentMode;

            if(url.searchParams.has("save")) {

                const whenValue = Number.parseInt(url.searchParams.get("save"));
                const when = new Date(whenValue);
                alert(`Saved ${when.toString()}`);

            }

            const currentId = maybeAtob(url.searchParams.get("id"));
            document.querySelectorAll("input[name='@id']").forEach(input => input.value = currentId);

            function setAll(selector, values) {
                const found = document.querySelectorAll(selector);
                for (const x of found) {
                    for (const key in values) {
                        x[key] = values[key];
                    }
                }
            }

            const editUrl = new URL(location.href);
            editUrl.searchParams.set("mode", "edit");
            setAll(".edit-link", { href: editUrl.toString() });

            const homeUrl = new URL(location.href);
            homeUrl.search = "";
            setAll(".home-link", { href: homeUrl.toString() });

            function currentObject(required = false) {
                if (!currentId) {
                    if (required) throw new Error("No id specified");
                    return;
                }
                const objectsQuery = teamsQuery.queryAll(`#${currentId}`);
                const objectQuery = objectsQuery.find(x => x.query(">@type"));
                if (!objectQuery) throw new Error("Not found (or not typed): " + id);
                return objectQuery;
            }

            function populateAndReturnObjectName(objectQuery, defaultValue) {
                const name =
                    ( objectQuery && objectQuery.query(">ots:name @value") )
                    ||
                    ( objectQuery && objectQuery.query(">ots:created @value") )
                    ||
                    defaultValue;
                emplaceText(".current-object-name", name);
                return name;
            }


            function navToShapeEditor(shapeName) {
                location.href = `?mode=edit&shape=${shapeName}&at=${Date.now()}`;
            }

            function currentShapeName(objectQuery) {
                if( !objectQuery) return url.searchParams.get("shape") || "Team";
                const objClass = objectQuery.query(">@type").filter(t => t.startsWith(context.ots))[0];
                return objClass && objClass.substring(context.ots.length);
            }

            function shapeForObject(objQuery) {
                const shapeName = currentShapeName(objQuery);
                return shapeName && shapeIndex[shapeName];
            }

            function editor() {

                document.body.classList.add("edit-mode");

                const objectQuery = currentObject();
                populateAndReturnObjectName(objectQuery, "new");

                const shapeName = currentShapeName(objectQuery);
                emplaceText(".current-shape-name", shapeName);

                for (var key in shapeIndex) {
                    const option = document.createElement("option");
                    option.value = key;
                    option.text = key;
                    if (option.value == shapeName) option.selected = true;
                    picker.add(option);
                }

                picker.addEventListener("change", e => navToShapeEditor(e.target.value));

                function render(shapeName) {
                    const shape = shapeIndex[shapeName];
                    document.title = `${shapeName} shape editor`;
                    const rendered = shape
                        .queryAll("sh:property")
                        .map(propQuery => renderPropEditor(propQuery, objectQuery))
                        .join("");
                    document.querySelector("#editor .inputs").innerHTML = rendered;
                }

                render(shapeName);

            }

            function browser() {

                const currentClass = maybeAtob(url.searchParams.get("class")) || `${context.ots}Team`;
                const currentClassPropQuery = schemaQuery.queryAll(`sh:class[@id=${currentClass}]`)
                    .map(x => x.parent())
                    .filter(x => !x.query("sh:maxCount"))
                [0];
                const currentClassName =
                    (currentClassPropQuery && currentClassPropQuery.query("sh:labelTemplate @value"))
                    || currentClass.substring(context.ots.length) + "s";
                emplaceText(".current-class-name", currentClassName);

                document.body.classList.add("browse-mode");

                const objs = teamsQuery.queryAll(`[@type=${currentClass}]`);
                const itemsList = document.querySelector("#items");
                objs.forEach(o => {

                    const id = o.query(">@id");
                    const li = document.createElement("LI");
                    if (id) {
                        const a = document.createElement("A");
                        a.href = id ? `?mode=view&id=${btoa(id)}` : "#";
                        a.textContent = o.query(">ots:name @value") || "??";
                        li.appendChild(a);
                    } else {
                        li.textContent = o.query(">ots:name @value") || "??";
                    }
                    itemsList.appendChild(li);

                });

            }

            function viewer() {

                document.body.classList.add("view-mode");
                const objectQuery = currentObject(true);
                const objName = populateAndReturnObjectName(objectQuery);

                const shape = shapeForObject(objectQuery);
                document.title = `${objName} viewer`;
                const rendered = shape.queryAll("sh:property").map(p => renderPropViewer(p, objectQuery)).join("");
                document.querySelector("#view").innerHTML = rendered;

            }

            switch (currentMode) {
                case "edit":
                    editor();
                    break;
                case "browse":
                    browser();
                    break;
                case "view":
                    viewer();
                    break;
                default:
                    alert("Unknown mode " + currentMode);
            }

        }());

    </script>
</head>

<body>
    <header>
        <a href="" class="home-link">Home</a>
        <span id="mode-name">loading</span> mode
    </header>
    <section id="edit-mode">
        <header>
            <h2>
                Edit
                <span class="current-shape-name"></span>:
                <span class="current-object-name"></span>
            </h2>
            <select id="picker"></select>
        </header>
        <form id="editor" method="POST" action="/edits?styff=1#2">

            <div class="inputs">

            </div>
            <div class="submission">
                <input type="hidden" name="@id" />
                <input type="submit" value="Save" />
            </div>

        </form>

    </section>
    <section id="browse-mode">
        <header>
            <h2><span class="current-class-name"></span></h2>
        </header>
        <ul id="items">
        </ul>
    </section>
    <section id="view-mode">
        <header>
            <h2>
                <span class="current-object-name"></span>
                <a href="#" class="edit-link" alt="edit">Edit</a>
            </h2>
        </header>
        <div id="view"></div>
    </section>
</body>

</html>