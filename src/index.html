<!DOCTYPE>
<html>

<head>
    <script type="module" src="./log.js"></script>
    <script type="module">
        import { load } from "./gapi.js";
        import { publish } from "./bus.js";
        import config from "./config.js";
        let safety = 10;
        function waitForGAPI(continuation) {
            if (safety-- < 1) {
                publish(config.bus.ERROR, "Timeout waiting for GAPI to load");
                return;
            }
            const script = document.querySelector("#gapi-script");
            if (script.dataset.loaded) continuation();
            else
                setTimeout(() => waitForGAPI(continuation), 100);
        }
        window.addEventListener("DOMContentLoaded", waitForGAPI(() =>

            load(window.gapi, {
                signInButton: document.querySelector("#gapi-signin")
            })

        ));
    </script>
    <script id="gapi-script" async defer src="https://apis.google.com/js/api.js" onload="this.dataset.loaded=true"
        onreadystatechange="if (this.readyState === 'complete') this.onload()"></script>
</head>

<body>
    Hello
    <button type="button" id="gapi-signin">Google Sign-in</button>
</body>

</html>